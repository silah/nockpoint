{% extends "base.html" %}

{% block title %}Outstanding Payments - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="bi bi-currency-dollar text-warning"></i> Outstanding Payments</h4>
                    <small class="text-muted">Manage unpaid charges for shooting events</small>
                </div>
                <a href="{{ url_for('events.calendar') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Calendar
                </a>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <div class="h4 text-warning">${{ "%.2f"|format(total_outstanding) }}</div>
                            <div class="small text-muted">Total Outstanding</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <div class="h4 text-danger">{{ outstanding_charges|length }}</div>
                            <div class="small text-muted">Unpaid Charges</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <div class="h4 text-info">{{ unique_members }}</div>
                            <div class="small text-muted">Members with Debt</div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by member name or event...">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group w-100">
                            <button type="button" class="btn btn-outline-primary active" onclick="showAll()">
                                All Charges
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="showOutstanding()">
                                Outstanding Only
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="showPaid()">
                                Paid Only
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Charges Table -->
                {% if all_charges %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="chargesTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Member</th>
                                    <th>Event</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for charge in all_charges %}
                                    <tr class="charge-row {% if charge.paid %}paid-charge{% else %}outstanding-charge{% endif %}" 
                                        data-member-name="{{ charge.member.first_name|lower }} {{ charge.member.last_name|lower }}"
                                        data-event-name="{{ charge.event.name|lower }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-person-circle text-muted me-2"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ charge.member.first_name }} {{ charge.member.last_name }}</div>
                                                    <small class="text-muted">{{ charge.member.email }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('events.view_event', id=charge.event.id) }}" 
                                               class="text-decoration-none">
                                                {{ charge.event.name }}
                                            </a>
                                            <br>
                                            <small class="text-muted">{{ charge.event.location }}</small>
                                        </td>
                                        <td>
                                            <div class="fw-semibold">{{ charge.event.date.strftime('%m/%d/%y') }}</div>
                                            <small class="text-muted">{{ charge.event.start_time.strftime('%I:%M %p') }}</small>
                                        </td>
                                        <td>
                                            <span class="fw-semibold">${{ "%.2f"|format(charge.amount) }}</span>
                                        </td>
                                        <td>
                                            {% if charge.paid %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Paid
                                                </span>
                                                {% if charge.paid_at %}
                                                    <br><small class="text-muted">{{ charge.paid_at.strftime('%m/%d/%y') }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-clock"></i> Outstanding
                                                </span>
                                                {% set days_outstanding = (moment().date() - charge.created_at.date()).days %}
                                                <br><small class="text-muted">{{ days_outstanding }} days ago</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ charge.created_at.strftime('%m/%d/%y %I:%M %p') }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if not charge.paid %}
                                                    <button type="button" class="btn btn-success btn-sm" 
                                                            onclick="markAsPaid({{ charge.id }})">
                                                        <i class="bi bi-cash"></i> Mark Paid
                                                    </button>
                                                    <button type="button" class="btn btn-outline-warning btn-sm" 
                                                            onclick="editCharge({{ charge.id }}, {{ charge.amount }})">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                {% else %}
                                                    <button type="button" class="btn btn-outline-warning btn-sm" 
                                                            onclick="markAsUnpaid({{ charge.id }})">
                                                        <i class="bi bi-arrow-counterclockwise"></i> Unpay
                                                    </button>
                                                {% endif %}
                                                <button type="button" class="btn btn-outline-danger btn-sm"
                                                        onclick="deleteCharge({{ charge.id }})">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination would go here if needed -->
                    {% if all_charges|length > 50 %}
                        <nav class="mt-3">
                            <p class="text-muted text-center">
                                Showing {{ all_charges|length }} charges. 
                                <a href="#" onclick="loadMore()">Load more...</a>
                            </p>
                        </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-currency-dollar display-1 text-muted"></i>
                        <h5 class="mt-3 text-muted">No Charges Found</h5>
                        <p class="text-muted">No payment charges have been created yet.</p>
                        <a href="{{ url_for('events.calendar') }}" class="btn btn-primary">
                            <i class="bi bi-calendar3"></i> View Events
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Charge Modal -->
<div class="modal fade" id="editChargeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Charge Amount</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editChargeForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_charge_id">
                    <div class="mb-3">
                        <label for="edit_amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="edit_amount" 
                                   step="0.01" min="0" max="999.99" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_reason" class="form-label">Reason for Change (Optional)</label>
                        <textarea class="form-control" id="edit_reason" rows="2" 
                                  placeholder="e.g., Discount applied, corrected amount..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Charge</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript for payment management -->
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.charge-row');
    
    rows.forEach(row => {
        const memberName = row.dataset.memberName;
        const eventName = row.dataset.eventName;
        const visible = memberName.includes(searchTerm) || eventName.includes(searchTerm);
        row.style.display = visible ? '' : 'none';
    });
});

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.charge-row').forEach(row => {
        row.style.display = '';
    });
}

// Filter functionality
function showAll() {
    document.querySelectorAll('.charge-row').forEach(row => row.style.display = '');
    updateActiveButton(0);
}

function showOutstanding() {
    document.querySelectorAll('.charge-row').forEach(row => {
        row.style.display = row.classList.contains('outstanding-charge') ? '' : 'none';
    });
    updateActiveButton(1);
}

function showPaid() {
    document.querySelectorAll('.charge-row').forEach(row => {
        row.style.display = row.classList.contains('paid-charge') ? '' : 'none';
    });
    updateActiveButton(2);
}

function updateActiveButton(index) {
    const buttons = document.querySelectorAll('.btn-group .btn');
    buttons.forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
    });
}

// Payment actions
function markAsPaid(chargeId) {
    if (confirm('Mark this charge as paid?')) {
        updatePaymentStatus(chargeId, true);
    }
}

function markAsUnpaid(chargeId) {
    if (confirm('Mark this charge as unpaid? This will move it back to outstanding.')) {
        updatePaymentStatus(chargeId, false);
    }
}

function updatePaymentStatus(chargeId, paid) {
    fetch(`{{ url_for('events.update_payment_status') }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            charge_id: chargeId,
            paid: paid
        })
    }).then(response => response.json()).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to update payment status');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

function editCharge(chargeId, currentAmount) {
    document.getElementById('edit_charge_id').value = chargeId;
    document.getElementById('edit_amount').value = currentAmount;
    document.getElementById('edit_reason').value = '';
    new bootstrap.Modal(document.getElementById('editChargeModal')).show();
}

document.getElementById('editChargeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const chargeId = document.getElementById('edit_charge_id').value;
    const amount = document.getElementById('edit_amount').value;
    const reason = document.getElementById('edit_reason').value;
    
    fetch(`{{ url_for('events.update_charge_amount') }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            charge_id: chargeId,
            amount: parseFloat(amount),
            reason: reason
        })
    }).then(response => response.json()).then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editChargeModal')).hide();
            location.reload();
        } else {
            alert(data.error || 'Failed to update charge amount');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
});

function deleteCharge(chargeId) {
    if (confirm('Delete this charge? This action cannot be undone.')) {
        fetch(`{{ url_for('events.delete_charge') }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                charge_id: chargeId
            })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to delete charge');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}
</script>
{% endblock %}
